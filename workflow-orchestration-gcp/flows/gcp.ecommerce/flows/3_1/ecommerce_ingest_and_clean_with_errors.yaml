id: ecommerce_ingest_and_clean_with_errors
namespace: gcp.ecommerce

variables:
  projectId: "kestra-workspace-ak-lde-2025"
  input_bucket: "lde-my-kestra-workspace"
  location: "EU"

tasks:
  # --- 1. Load RAW data from GCS into BigQuery ---
  - id: load_raw
    type: io.kestra.plugin.gcp.bigquery.LoadFromGcs
    serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
    from:
      - "gs://{{ vars.input_bucket }}/data.csv"
    destinationTable: "{{ vars.projectId }}.raw.transactions_raw"
    format: CSV
    autodetect: true
    csvOptions:
      skipLeadingRows: 1
    writeDisposition: WRITE_TRUNCATE

  # --- 2. CLEAN table: cast only important fields + business rules ---
  - id: clean_data
    type: io.kestra.plugin.gcp.bigquery.Query
    serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
    projectId: "{{ vars.projectId }}"
    location: "{{ vars.location }}"
    sql: |
      CREATE OR REPLACE TABLE `{{ vars.projectId }}.clean.transactions` AS
      SELECT
        InvoiceNo,
        StockCode,
        Description,
        SAFE_CAST(Quantity AS INT64) AS Quantity,
        SAFE_CAST(UnitPrice AS FLOAT64) AS UnitPrice,
        SAFE_CAST(InvoiceDate AS TIMESTAMP) AS InvoiceDate,
        CustomerID,
        Country
      FROM `{{ vars.projectId }}.raw.transactions_raw`
      WHERE SAFE_CAST(Quantity AS INT64) > 0
        AND SAFE_CAST(UnitPrice AS FLOAT64) > 0
        AND InvoiceNo NOT LIKE 'C%';

  # --- 3. ERROR table: everything that failed clean conditions ---
  - id: error_data
    type: io.kestra.plugin.gcp.bigquery.Query
    serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
    projectId: "{{ vars.projectId }}"
    location: "{{ vars.location }}"
    sql: |
      CREATE OR REPLACE TABLE `{{ vars.projectId }}.clean.transactions_errors` AS
      SELECT *
      FROM `{{ vars.projectId }}.raw.transactions_raw`
      WHERE NOT (
        SAFE_CAST(Quantity AS INT64) > 0
        AND SAFE_CAST(UnitPrice AS FLOAT64) > 0
        AND InvoiceNo NOT LIKE 'C%'
      );