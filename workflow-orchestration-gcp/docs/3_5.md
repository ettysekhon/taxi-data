## Set the variables in the cli (change them to yours)
```
PROJECT="kestra-workspace-ak-lde-2025"
TOPIC="file-upload-events"
SUB="file-upload-sub"
BUCKET="lde-my-kestra-workspace"
```

## Create Pub/sub topic
```
gcloud pubsub topics create "$TOPIC" --project "$PROJECT"
```
## Create a subscription
```
gcloud pubsub subscriptions create "$SUB" \
  --project "$PROJECT" \
  --topic "$TOPIC"
```
## Configure GCS Bucket -> Pub/Sub notifications
```
gsutil notification create -f json -t "projects/$PROJECT/topics/$TOPIC" "gs://$BUCKET"
```
## Give Cloud Storage the rights to write to the topic
```
PROJECT_NUMBER="$(gcloud projects describe "$PROJECT" --format='value(projectNumber)')"

gcloud pubsub topics add-iam-policy-binding "$TOPIC" \
  --project "$PROJECT" \
  --member="serviceAccount:service-${PROJECT_NUMBER}@gs-project-accounts.iam.gserviceaccount.com" \
  --role="roles/pubsub.publisher"
```

## Enable the Pub/Sub API
Go to APIs & Services in the console

## Set Pub/Sub admin for service Admin
```
gcloud projects add-iam-policy-binding YOUR_PROJECT \
  --member="serviceAccount:KESRTA_SA@YOUR_PROJECT.iam.gserviceaccount.com" \
  --role="roles/pubsub.subscriber"
```
or just go and give the user pub/sub admin rights

## Event driven flow

[Link to the flow an GitHub](https://github.com/andkret/kestra-demo/blob/9ae8ae5d8ffdd5c560e254db4d6573ba3e0b82fa/gcp.yellowcab/flows/3_5/event-file-ingest.yaml)